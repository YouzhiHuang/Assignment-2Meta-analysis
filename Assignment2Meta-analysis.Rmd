---
title: "Assignment #2: Meta Analysis"
author: "u7457916 Youzhi Huang"
date: "2022/10/25"
output:
 bookdown::html_document2:
    code_folding: show
    number_sections: no
    toc: yes
    toc_depth: 6
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This is [My GitHub Repository](https://github.com/YouzhiHuang/Assignment-2Meta-analysis-of-Ocean-Acidification-Effects-on-Behaviour)

## **Load the necessary R Packages**

```{r loadpacks, message=FALSE, results='hide'}
# Install a load of packages that we'll use.
library(pacman)
p_load(bookdown, devtools, tidyverse, ggforce, GGally, flextable, latex2exp, png, magick, metafor, MASS, emmeans, R.rsp,viridis,patchwork)
# Install the orchaRd package 
# devtools::install_github("daniel1noble/orchaRd", force = TRUE)
library(orchaRd)

```
## Add the article by [Clark et al. (2020)](https://doi.org/10.1038/s41586-019-1903-y) to the Meta-analysis dataset

### **Analysis of[Clark et al. (2020)](https://doi.org/10.1038/s41586-019-1903-y) for each of the fish species’ `average activity` for each treatment.**

First, we load the data and clean it
```{r datalaod,message=FALSE}
# Load data file from the data folder
path <- "./data/OA_activitydat_20190302_BIOL3207.csv"
data <- read_csv(path)

```

```{r Data wrangling}
# Code to removing missing data 
comp_data <-  data %>% drop_na()
# Drop irrelevant columns
Sp_Tr <- comp_data %>% dplyr::select(-c(...1,comment,loc,animal_id,sl,size))
# Check spelling in species and treatment but also generate a summary table
unique(Sp_Tr$species)
unique(Sp_Tr$treatment)

```

Well, the data is good. Next we statistically analyse this data by [Clark et al. (2020)](https://doi.org/10.1038/s41586-019-1903-y).

```{r Calculate and visualise statistics}
# Use flextable to render the summary table in a tidy format
use_df_printer()
set_flextable_defaults(
  theme_fun = theme_booktabs,
  big.mark = " ", 
  font.color = "#666666",
  border.color = "#666666",
  padding = 3,
)
# Create a summary of the original dataset.
dat <- Sp_Tr %>%
  group_by(treatment,species) %>%
  summarise(n=n(),
    across(
      where(is.numeric), 
      .fns = list(
        avg = ~ mean(.x, na.rm = TRUE),
        sd = ~ sd(.x, na.rm = TRUE)
      )
    ),.groups = "drop" ) %>%
  subset(select=-c(n_avg,n_sd))
fdata <-  as_tibble(dat)
# Use flextable to render the summary table
ft <-  fdata%>%
  flextable() %>%
  separate_header() %>%
  merge_v(j = c("treatment","species")) %>%
  theme_booktabs(bold_header = TRUE)  %>% 
  valign(j = 1, valign = "top") %>%
  align(align = "center", part = "all", j = 4:5)%>%
  colformat_double(digits = 2)  %>%
  autofit()   %>%
  footnote(i = 2, j = grep("avg", colnames(fdata), value = TRUE), 
           part = "header",
           ref_symbols = " ",
            value = as_paragraph("avg: Arithmetic Mean")) %>% 
  footnote(i = 2, j = grep("sd", colnames(fdata), value = TRUE), 
           part = "header",
           ref_symbols = " ", value = as_paragraph("sd: Standard Deviation"))
ft 
```

So, we have generated the summary statistics (means, SD, N) for each of the fish species’ average activity for each treatment.  
We next merge these statistics from [Clark et al. (2020)](https://doi.org/10.1038/s41586-019-1903-y) into a form used for meta-analysis.  

### Merge the summary statistics generated from from [Clark et al. (2020)](https://doi.org/10.1038/s41586-019-1903-y) with the metadata

```{r load metadata,message=FALSE}
# Load data file from the data folder
matadata <- read_csv("./data/clark_paper_data.csv")

```

Collation of data from [Clark et al. (2020)](https://doi.org/10.1038/s41586-019-1903-y) into a form ready for Meta-analysis 
```{r clarkdata wrangling}
# Turn and statistics into wide data for merging
wider <- pivot_wider(fdata,names_from = treatment, values_from = c(n,activity_avg,activity_sd))
names(wider) <- c("Species","oa.n","ctrl.n","oa.mean","ctrl.mean","oa.sd","ctrl.sd")
# Repeat metadata to accommodate statistics
matadatarep <- matadata[rep(seq_len(nrow(matadata)),each=6),]
# Merge them and look at the result
meta_clark <- bind_cols(matadatarep,wider)
meta_clark
```

Great, we have converted the data from [Clark et al. (2020)](https://doi.org/10.1038/s41586-019-1903-y) into a form ready for meta-analysis.    
Next, we merge the collated data from [Clark et al. (2020)](https://doi.org/10.1038/s41586-019-1903-y) with the larger set of metadata.

### Merge metadata from larger meta-analysis datase

```{r load ocean metadata,message=FALSE}
ocean_matadata <- read_csv("./data/ocean_meta_data.csv")
```

```{r Merge two metadata}
oceanmatadata <- merge(x = ocean_matadata, y = meta_clark, all = TRUE)
oceanmatadata
```

Combining the data from [Clark et al. (2020)](https://doi.org/10.1038/s41586-019-1903-y) into a larger meta-dataset form [Clements et al. (2022)](https://doi.org/10.1371/journal.pbio.3001511) gives us the full dataset available for meta-analysis.
But don't forget to collate the data before analysis for the subsequent Meta-analysis.

```{r metadata wrangling-name}
# Rebuild the variable name avoiding spaces 
names(oceanmatadata)[3:4] <- c("Year_online","Year_print")
names(oceanmatadata)[7:10] <- c("Pub_year_IF","2017_IF","Average_n","Effect_type")
names(oceanmatadata)[12:16] <- c("Climate_FishBase","Env_cue/stimulus?","Cue/stimulus_type","Behavioural_metric","Life_stage")
# check spell
unique(sort(oceanmatadata$Species))
```

We can find that the species nomenclature of [Clark et al. (2020)](https://doi.org/10.1038/s41586-019-1903-y) differs from that of [Clements et al. (2022)](https://doi.org/10.1371/journal.pbio.3001511). By reviewing [the original literature](https://doi.org/10.1038/s41586-019-1903-y) of Clark et al. we were able to unify their species nomenclature into a binomial approach consistent with [Clements et al. (2022)](https://doi.org/10.1371/journal.pbio.3001511).

```{r metadata wrangling-spell}
oceanmatadata$Species[oceanmatadata$Species == "acantho"] <- "Acanthochromis polyacanthus"
oceanmatadata$Species[oceanmatadata$Species == "ambon"] <- "Pomacentrus amboinensis"
oceanmatadata$Species[oceanmatadata$Species == "chromis"] <- "Chromis atripectoralis"
oceanmatadata$Species[oceanmatadata$Species == "humbug"] <- "Dascyllus aruanus"
oceanmatadata$Species[oceanmatadata$Species == "lemon"] <- "Pomacentrus moluccensis"
oceanmatadata$Species[oceanmatadata$Species == "whitedams"] <- "Dischistodus perspicillatus"
summary(oceanmatadata)
```

We can roughly see that there are no more unusual elements in the metadata set. So we can now perform a meta-analysis on this merged metadata.

## A meta-analysis of ocean acidification metadata sets

First, we have to calculate the effect size(log response ratio, lnRR) we used for the meta-analysis.  

### 4.calculate the log response ratio (lnRR) effect size for every row

lnRR is defined as
$$
lnRR = ln \left( \frac{M_E}{M_C}\right)
$$
where $$M_E$$ and $$M_C$$  are the average measured response in the experimental and control treatments, respectively. 
So in order to calculate lnRR, we have to first filter the NA values and calculate the resulting NaN values.
```{r lnRRfilter}
# Exclude some NA's in sample size and r
cleanoceanmatadata <- oceanmatadata[complete.cases(oceanmatadata$ctrl.mean) & complete.cases(oceanmatadata$oa.mean)& complete.cases(oceanmatadata$ctrl.sd)& complete.cases(oceanmatadata$oa.sd)& complete.cases(oceanmatadata$ctrl.n)& complete.cases(oceanmatadata$oa.n),]
cleanInRRdata <- cleanoceanmatadata %>% filter(oa.mean/ctrl.mean >=0)
```

Calculate lnRR and the absolute value of lnRR that may be used later. And add them to our meta dataset.

```{r lnRRcalculated}
InRRdata <-  metafor::escalc(measure="ROM", m1i=oa.mean,  m2i=ctrl.mean, sd1i=oa.sd, sd2i=ctrl.sd, n1i=oa.n, n2i=ctrl.n, data=cleanInRRdata,var.names = c("lnRR", "V_lnRR"))
InRRdata$abslnRR <- abs(InRRdata$lnRR)
InRRdata
```

### meta-analytic model fitted to the data

```{r}
# Multi-level meta-analytic model
InRRdata$abslnRR <- abs(InRRdata$lnRR)
InRRdata$Observation <- rep(1:nrow(InRRdata))
#InRRdata$Study <- gsub("a"," ",InRRdata$Study)
#InRRdata
MLMA <- metafor::rma.mv(abslnRR  ~ 1, V = V_lnRR, method = "REML", random=list( ~1|Study,~1|Observation),dfs = "contain",data=InRRdata)
MLMA

```

Uncertainty in the overall meta-analysis mean: 95% confidence interval

Based on the results of our multilevel meta-analysis model, a 95% confidence interval ranging from -0.3505 to 0.0976 can be obtained. In other words, at 95%, our point estimate expects the true mean to fall between the InRR values of -0.3505 and 0.0976.


Test the null hypothesis about whether the overall meta-analytic mean is different from 0.
We can also see that the original hypothesis that lnRR is equal to 0 cannot be rejected, as 0 falls within the 95% confidence interval of the estimate, as we can see from the p-value > 0.05. To be more precise, the p-value is 0.2654.


```{r}
# Calculate I2
i2_vals <- orchaRd::i2_ml(MLMA)

# Make a pretty table. First, lets clean up the names of the different I2
# estimates. Lets remove I2_. It's a string, so, we can use some regular
# expressions to fix that. `gsub` is pretty useful. You put a pattern in and
# tell it what you would like to replace the text with. In this case, just
# blank will do! Then, we'll make the first letter of what is left
# capitalised.
i2 <- tibble(type = firstup(gsub("I2_", "", names(i2_vals))), I2 = i2_vals)


# You remember flextable. Now, lets make a pretty table. We can so some nice
# modifications here too.

flextable(i2) %>%
    align(part = "header", align = "center") %>%
    compose(part = "header", j = 1, value = as_paragraph(as_b("Type"))) %>%
    compose(part = "header", j = 2, value = as_paragraph(as_b("I"), as_b(as_sup("2")),
        as_b("(%)")))




```


```{r}
# Calculate the prediction intervals
pis <- predict(MLMA)
pis

```

Our 95% prediction interval is wide. The effect size (InRR) is expected to range from -0.659 to 0.854 in 95% replicate experiments, suggesting that there are many inconsistencies between studies.










```{r}
# Make an orchard plot using the model object
orchaRd::orchard_plot(MLMA, group = "Study", data = InRRdata,
    xlab = "Z-Transformed Correlation Coefficient (Zr)",transfm = "none")

model_results <- mod_results(MLMA, mod = "1", at = NULL, data = InRRdata, group = "Study")
model_results
# a caterpillar plot (not a caterpillars plot)
orchaRd::caterpillars(model_results, mod="Int", xlab = "Standardised mean difference") 

```

```{r}


```


## Funnel plot for visually assessing the possibility of publication bias
```{r}
# Lets make a funnel plot to visualize the data in relation to the precision,
# inverse sampling standard error,
metafor::funnel(x = InRRdata$lnRR, vi = InRRdata$V_lnRR,yaxis = "ni",digits = 2, level = c(0.1, 0.05, 0.01),shade = c("white", "gray55", "gray 75"),las = 1, xlab = "Correlation Coefficient (r)",legend=TRUE)


funnel<-ggplot(InRRdata,aes(x=lnRR, y=Average_n, color=Study))+
  geom_point(size=2,alpha=0.6)+ 
  scale_color_viridis(discrete=TRUE)+ 
  xlab("Effect size magitude (lnRR)")+
  ylab("Mean sample size")+
  scale_x_continuous(breaks = round(seq(min(InRRdata$lnRR), max(InRRdata$lnRR), by = 1),0))+
  scale_y_continuous(breaks = round(seq(0, 600, by = 50),1))+
  theme(legend.position = "NONE")+
  geom_vline(xintercept =0,linetype="dashed",color="red")+
  theme_bw(12)+
  theme(legend.position = "NONE")+ 
  theme(panel.grid.minor = element_blank())

funnel


```





```{r}
ggplot(InRRdata, aes(y = lnRR, x = V_lnRR)) + geom_point() + geom_smooth(method = lm) +
    labs(y = "Fisher's Z-transformed Correlation Coefficient (Zr)", x = "Sampling Variance of Zr") +
    theme_classic()


```


Time-lag plot assessing how effect sizes may or may not have changed through time.
```{r}
Time_lag <- ggplot(InRRdata, aes(y = abslnRR, x = Year_online, color=Study)) + 
    geom_smooth(aes(alpha=0.05),method = "loess",se=TRUE, fullrange=TRUE, level=0.95, color="black",show.legend = T)+
   geom_point(size=InRRdata$Average_n*0.03,alpha = 0.3) +
  #scale_size(range = c(1, 2), name="Sample size")+ 
  scale_color_viridis(discrete=TRUE)+ 
   geom_hline(yintercept =0,linetype="dashed",color="red")+
  xlab("Year")+ylab("Effect size magnitude (lnRR)")+
scale_x_continuous(breaks = round(seq(min(InRRdata$Year_online), max(InRRdata$Year_online), by = 1),1))+
  scale_y_continuous(breaks = round(seq(min(InRRdata$lnRR), 15, by = 2),0)) + theme_minimal(12)+
  theme(legend.position = "none")
Time_lag

```


## Formal meta-regression model that includes year as a moderator (fixed effect) to test for time-lag bias


```{r}
metareg_v <- rma.mv(lnRR ~ V_lnRR, V = V_lnRR, random = list(~1 |Study, ~1 | Observation),
    test = "t", dfs = "contain", data = InRRdata)
summary(metareg_v)

r2 <- orchaRd::r2_ml(metareg_v)
r2

```


```{r}
# Including sampling variance as moderator
metareg_time <- rma.mv(lnRR ~ Year_online, V = V_lnRR, random = list(~1 |Study, ~1 | Observation),
    test = "t", dfs = "contain", data = InRRdata)
summary(metareg_time)

```

```{r}
# How much variation does time when results were published explain in Zr?
r2_time <- orchaRd::r2_ml(metareg_time)  #'ADD YOUR CODE HERE'
r2_time
```


```{r}
# Including sampling variance as moderator
metareg_time1 <- rma.mv(abslnRR ~ Year_online, V = V_lnRR, random = list(~1 |Study, ~1 | Observation),
    test = "t", dfs = "contain", data = InRRdata)
summary(metareg_time1)
r2_time1 <- orchaRd::r2_ml(metareg_time1)  #'ADD YOUR CODE HERE'
r2_time1
```


## 10 Formal meta-regression model that includes inverse sampling variance (i.e., 1vlnRR) to test for file-drawer biases

```{r}
# Including sampling variance and year as moderators to account for both!
metareg_time2 <- rma.mv(abslnRR ~ Year_online + V_lnRR,  V = V_lnRR,random = list(~1 |Study, ~1 | Observation),
    test = "t", dfs = "contain", data = InRRdata)
summary(metareg_time2)
r2_time2 <- orchaRd::r2_ml(metareg_time2)  #'ADD YOUR CODE HERE'
r2_time2

```

```{r}
InRRdata <- InRRdata %>%
    mutate(Year_c = Year_online - mean(Year_online))  # 'ADD YOUR CODE HERE'
# Including sampling variance and mean centered year as moderators to account
# for both!
metareg_time_c <- rma.mv(abslnRR ~ Year_c + V_lnRR,  V = V_lnRR,random = list(~1 |Study, ~1 | Observation),
    test = "t", dfs = "contain", data = InRRdata)
summary(metareg_time_c)  # 'ADD YOUR CODE HERE'


```

## 11 A written paragraph that discusses the potential for publication bias based on the meta-regression results. What type of publication bias, if any, appears to be present in the data? If publication bias is present, what does it mean and what might be contributing to such bias?



## 12 Identify any studies contributing to publication bias. How do your updated meta-analysis results compare with a meta-analysis by Clement et. al. (2022)? Are there any concerns about these studies? If so, describe using references to existing papers what concerns have been raised?









